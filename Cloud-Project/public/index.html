<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CarCounter</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; }
    section { margin-bottom: 2rem; }
    input, button { padding: 0.5rem; margin: 0.25rem 0; }
    #gallery img { max-width: 320px; margin: 6px; }
    .muted { color: #666; font-size: 0.95rem; }
    .err { color: #b00020; white-space: pre-wrap; }
    .ok { color: #0a7a0a; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 720px) { .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Video Analysis</h1>

  <!-- SIGN UP -->
  <section>
    <h2>Sign up</h2>
    <div class="row">
      <form id="signupForm">
        <input type="text" id="su_username" placeholder="Username" required>
        <input type="email" id="su_email" placeholder="Email" required>
        <input type="password" id="su_password" placeholder="Password" required>
        <button type="submit">Create account</button>
      </form>

      <form id="confirmForm">
        <input type="text" id="cf_username" placeholder="Username to confirm" required>
        <input type="text" id="cf_code" placeholder="Confirmation code" required>
        <button type="submit">Confirm account</button>
      </form>
    </div>
    <p id="signupStatus" class="muted"></p>
  </section>

  <!-- LOGIN -->
  <section>
    <h2>Login</h2>
    <form id="loginForm">
      <input type="text" id="username" placeholder="Username (or email, per pool settings)" required>
      <input type="password" id="password" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>
    <p id="loginStatus" class="muted"></p>
  </section>

  <!-- UPLOAD -->
  <section>
    <h2>Upload video</h2>
    <form id="uploadForm">
      <input type="file" id="videoFile" accept="video/*" required>
      <button type="submit">Analyze</button>
    </form>
    <p id="uploadStatus" class="muted"></p>
  </section>

  <!-- RESULTS -->
  <section>
    <h2>Results</h2>
    <input type="text" id="jobId" placeholder="Job ID">
    <button id="checkResult">Fetch result</button>
    <pre id="resultOutput"></pre>

    <video id="videoPlayer" controls style="display:none;width:100%;max-width:720px;"></video>
    <div id="gallery"></div>
  </section>

  <script>
    // Empty base = same-origin (http://localhost:3000 when served by your app)
    const API = "";
    let token = null;

    function show(el, msg, ok=false) {
      el.textContent = msg || "";
      el.className = ok ? "ok" : (msg ? "err" : "muted");
    }

    // ---- SIGN UP (/auth/signup) ----
    document.getElementById("signupForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("su_username").value.trim();
      const email    = document.getElementById("su_email").value.trim();
      const password = document.getElementById("su_password").value;
      const statusEl = document.getElementById("signupStatus");
      show(statusEl, "Creating account...");

      try {
        const res = await fetch(`${API}/auth/signup`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, email, password }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data.message || data.error || `HTTP ${res.status}`;
          show(statusEl, `Sign up failed: ${msg}`);
          return;
        }

        show(statusEl, "Sign up OK. Check your email for the confirmation code.", true);
        // prefill confirm form
        document.getElementById("cf_username").value = username;
      } catch (err) {
        show(statusEl, `Network error during sign up: ${err.message}`);
      }
    });

    // ---- CONFIRM (/auth/confirm) ----
    document.getElementById("confirmForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("cf_username").value.trim();
      const code     = document.getElementById("cf_code").value.trim();
      const statusEl = document.getElementById("signupStatus");
      show(statusEl, "Confirming...");

      try {
        const res = await fetch(`${API}/auth/confirm`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, code }),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = data.message || data.error || `HTTP ${res.status}`;
          show(statusEl, `Confirm failed: ${msg}`);
          return;
        }

        show(statusEl, "Account confirmed. You can now log in.", true);
        // prefill login user
        document.getElementById("username").value = username;
      } catch (err) {
        show(statusEl, `Network error during confirm: ${err.message}`);
      }
    });

    // ---- LOGIN (Cognito via /auth/login) ----
    document.getElementById("loginForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value;
      const statusEl = document.getElementById("loginStatus");
      show(statusEl, "Logging in...");

      try {
        const res = await fetch(`${API}/auth/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password }),
        });
        const data = await res.json().catch(() => ({}));

        // Handle challenge surfacing if you implemented that on the server
        if (!res.ok) {
          if (data && data.error === "challenge_required") {
            show(statusEl, `Challenge required: ${data.challenge}. (Complete via the appropriate endpoint.)`);
            return;
          }
          const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
          show(statusEl, `Login failed: ${msg}`);
          return;
        }

        token = data.id_token || data.access_token || null;
        if (!token) {
          show(statusEl, "Login succeeded but no token was returned. (Challenge or server response issue.)");
          return;
        }
        show(statusEl, "Logged in!", true);
      } catch (err) {
        show(statusEl, `Network error during login: ${err.message}`);
      }
    });

    // ---- UPLOAD & START ANALYSIS (/videos/analyze, protected) ----
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById("uploadStatus");

      if (!token) { show(statusEl, "Please log in first."); return; }

      const file = document.getElementById("videoFile").files[0];
      if (!file) { show(statusEl, "Choose a video file first."); return; }

      const form = new FormData();
      form.append("video", file);

      show(statusEl, "Uploading and starting analysis...");

      try {
        const res = await fetch(`${API}/videos/analyze`, {
          method: "POST",
          headers: { "Authorization": `Bearer ${token}` },
          body: form,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
          show(statusEl, `Error: ${msg}`);
          return;
        }

        show(statusEl, "Job started: " + JSON.stringify(data), true);
        if (data.jobId) document.getElementById("jobId").value = data.jobId;
      } catch (err) {
        show(statusEl, `Network error: ${err.message}`);
      }
    });

    // ---- FETCH RESULT (/videos/:id, protected) ----
    document.getElementById("checkResult").addEventListener("click", async () => {
      const outEl = document.getElementById("resultOutput");
      const videoEl = document.getElementById("videoPlayer");
      const gallery = document.getElementById("gallery");

      if (!token) { outEl.textContent = "Please log in first."; return; }

      const id = document.getElementById("jobId").value.trim();
      if (!id) { outEl.textContent = "No JobID."; return; }

      outEl.textContent = "Fetching result...";
      videoEl.removeAttribute("src");
      videoEl.style.display = "none";
      gallery.innerHTML = "";

      try {
        const res = await fetch(`${API}/videos/${encodeURIComponent(id)}`, {
          headers: { "Authorization": `Bearer ${token}` },
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          outEl.textContent = "Error: " + (data.message || data.error || `HTTP ${res.status}`);
          return;
        }

        outEl.textContent = JSON.stringify(data, null, 2);

        if (data.status === "done" && data.video) {
          videoEl.src = data.video;
          videoEl.style.display = "block";
        }

        if (data.status === "done" && Array.isArray(data.images)) {
          if (data.images.length === 0) {
            const p = document.createElement('p');
            p.textContent = "No snapshots";
            gallery.appendChild(p);
          } else {
            data.images.forEach(url => {
              const img = document.createElement('img');
              img.src = url;  // presigned HTTPS
              img.loading = "lazy";
              gallery.appendChild(img);
            });
          }
        }
      } catch (err) {
        outEl.textContent = `Network error: ${err.message}`;
      }
    });
  </script>
</body>
</html>
